# Architecture - システム構成

## 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        Client (Browser)                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ HTTP (Port 80)
┌─────────────────────────────────────────────────────────────┐
│                         Nginx                                │
│  - 静的ファイル配信 (/public/)                                │
│  - リバースプロキシ                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ HTTP (Port 8080)
┌─────────────────────────────────────────────────────────────┐
│                    Application Server                        │
│         (Ruby/Go/PHP/Python/Node.js のいずれか)               │
└─────────────────────────────────────────────────────────────┘
           │                                    │
           ▼ TCP (Port 3306)                    ▼ TCP (Port 11211)
┌─────────────────────┐              ┌─────────────────────┐
│       MySQL 8.4      │              │     Memcached 1.6   │
│  - ユーザーデータ     │              │  - セッション管理    │
│  - 投稿データ        │              │                     │
│  - 画像データ(BLOB)  │              │                     │
└─────────────────────┘              └─────────────────────┘
```

---

## Docker Compose構成

```yaml
services:
  nginx:      # リバースプロキシ (Port 80)
  app:        # アプリケーション (Port 8080, 内部)
  mysql:      # データベース (Port 3306)
  memcached:  # キャッシュ (Port 11211, 内部)
```

---

## コンポーネント詳細

### Nginx

| 項目 | 値 |
|------|-----|
| イメージ | nginx:1.28 |
| ポート | 80 |
| 役割 | リバースプロキシ、静的ファイル配信 |

**設定ファイル:**
- 通常: `etc/nginx/conf.d/default.conf`
- PHP用: `etc/nginx/conf.d/php.conf`

### Application Server

| 項目 | 値 |
|------|-----|
| ポート | 8080（内部） |
| CPU制限 | 1コア |
| メモリ制限 | 1GB |

### MySQL

| 項目 | 値 |
|------|-----|
| イメージ | mysql:8.4 |
| ポート | 3306 |
| ユーザー | root |
| パスワード | root |
| データベース | isuconp |

### Memcached

| 項目 | 値 |
|------|-----|
| イメージ | memcached:1.6 |
| ポート | 11211（内部） |

---

## 環境変数

| 変数名 | 説明 | デフォルト値 |
|--------|------|-------------|
| ISUCONP_DB_HOST | DBホスト | mysql |
| ISUCONP_DB_PORT | DBポート | 3306 |
| ISUCONP_DB_USER | DBユーザー | root |
| ISUCONP_DB_PASSWORD | DBパスワード | root |
| ISUCONP_DB_NAME | DB名 | isuconp |
| ISUCONP_MEMCACHED_ADDRESS | Memcachedアドレス | memcached:11211 |

---

## リクエストフロー

### 認証フロー

```
1. POST /login (account_name, password)
2. サーバー: パスワードハッシュを検証
   └─ SHA512(password + ":" + SHA512(account_name))
3. 成功時: セッションにユーザーID保存
4. リダイレクト → /
```

### 画像配信フロー

```
1. GET /image/{post_id}.{ext}
2. サーバー: postsテーブルからimgdata取得
3. レスポンス: 画像バイナリ

※ ボトルネック: 画像がDBのBLOBに格納
```

### タイムライン生成フロー

```
1. GET /
2. postsテーブルから最新投稿取得
3. 各投稿について:
   ├─ usersテーブルからユーザー情報取得
   ├─ commentsテーブルからコメント数取得
   └─ commentsテーブルから最新3件取得

※ N+1問題: 投稿ごとに複数クエリ発行
```
